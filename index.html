<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote - Blocage Vendredi | Université de Montpellier</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
          // CONFIGURATION - Remplacez par vos propres clés
        const CONFIG = {
            emailjs: {
                publicKey: 'ybv8Cop9hM8NIwgSI', // À obtenir sur emailjs.com
                serviceId: 'service_nb31k2f',
                templateId: 'template_32n8ytl'
            },
            googleSheets: {
                scriptUrl: 'https://script.google.com/macros/s/AKfycbwd2W8vxGHmuARlVdD6J-RZtM8SSyIqjhHMd3qw42iw-gYDFjtFLqiu6-NrsWESqNw_dA/exec' // URL du script Google Sheets
            }
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialiser EmailJS
        emailjs.init(CONFIG.emailjs.publicKey);

        // Icônes
        const AlertCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const Mail = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
        );

        const Loader = ({ className }) => (
            <svg className={className} fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        function UMontpellierForm() {
          const [step, setStep] = useState('email');
          const [email, setEmail] = useState('');
          const [verificationCode, setVerificationCode] = useState('');
          const [generatedCode, setGeneratedCode] = useState('');
          const [error, setError] = useState('');
          const [loading, setLoading] = useState(false);
          const [canResend, setCanResend] = useState(true);
          const [countdown, setCountdown] = useState(0);
          const [formData, setFormData] = useState({
            position: '',
            commentaire: ''
          });

          useEffect(() => {
            checkIfAlreadyVoted();
            checkRateLimit();
          }, []);

          useEffect(() => {
            let timer;
            if (countdown > 0) {
              timer = setTimeout(() => setCountdown(countdown - 1), 1000);
            } else if (countdown === 0 && !canResend) {
              setCanResend(true);
            }
            return () => clearTimeout(timer);
          }, [countdown, canResend]);

          const checkIfAlreadyVoted = async () => {
            const submitted = localStorage.getItem('formSubmitted');
            const submittedEmail = localStorage.getItem('submittedEmail');
            if (submitted && submittedEmail) {
              setEmail(submittedEmail);
              setStep('blocked');
            }
          };

          const checkRateLimit = () => {
            const lastAttempt = localStorage.getItem('lastEmailAttempt');
            if (lastAttempt) {
              const timeSince = Date.now() - parseInt(lastAttempt);
              const cooldown = 420000; // 420 secondes = 7 minutes
              if (timeSince < cooldown) {
                const remaining = Math.ceil((cooldown - timeSince) / 1000);
                setCountdown(remaining);
                setCanResend(false);
              }
            }
          };

          const recordEmailAttempt = () => {
            localStorage.setItem('lastEmailAttempt', Date.now().toString());
            const attempts = JSON.parse(localStorage.getItem('emailAttempts') || '[]');
            attempts.push(Date.now());
            // Garder seulement les 10 dernières tentatives
            if (attempts.length > 10) attempts.shift();
            localStorage.setItem('emailAttempts', JSON.stringify(attempts));
          };

          const checkTooManyAttempts = () => {
            const attempts = JSON.parse(localStorage.getItem('emailAttempts') || '[]');
            const recentAttempts = attempts.filter(time => Date.now() - time < 7200000); // 2 heures
            return recentAttempts.length >= 2; // Max 2 tentatives par 2 heures
          };

          const validateEmail = (email) => {
            const regex = /^[a-zA-Z0-9._%+-]+@etu\.umontpellier\.fr$/;
            return regex.test(email);
          };

          const sendVerificationEmail = async (email, code) => {
            try {
              await emailjs.send(
                CONFIG.emailjs.serviceId,
                CONFIG.emailjs.templateId,
                {
                  to_email: email,
                  verification_code: code,
                  to_name: email.split('@')[0]
                }
              );
              return true;
            } catch (error) {
              console.error('Erreur envoi email:', error);
              return false;
            }
          };

          const saveVoteToGoogleSheets = async (voteData) => {
            try {
              const response = await fetch(CONFIG.googleSheets.scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(voteData)
              });
              return true;
            } catch (error) {
              console.error('Erreur sauvegarde:', error);
              return false;
            }
          };

          const handleEmailSubmit = async (e) => {
            e.preventDefault();
            setError('');
            setLoading(true);

            if (!validateEmail(email)) {
              setError('Veuillez utiliser une adresse email valide @etu.umontpellier.fr');
              setLoading(false);
              return;
            }

            // Vérifier si trop de tentatives
            if (checkTooManyAttempts()) {
              setError('Trop de tentatives d\'envoi. Veuillez réessayer dans 2 heures.');
              setLoading(false);
              return;
            }

            // Vérifier le cooldown
            if (!canResend) {
              setError(`Veuillez attendre ${countdown} secondes avant de renvoyer un code.`);
              setLoading(false);
              return;
            }

            // Générer code de vérification
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            setGeneratedCode(code);
            
            // Enregistrer la tentative
            recordEmailAttempt();
            setCanResend(false);
            setCountdown(420); // 420 secondes de cooldown = 7 minutes
            
            // Envoyer l'email
            const emailSent = await sendVerificationEmail(email, code);
            
            if (emailSent) {
              setStep('verify');
            } else {
              setError('Erreur lors de l\'envoi de l\'email. Vérifiez la configuration EmailJS.');
            }
            
            setLoading(false);
          };

          const handleVerification = (e) => {
            e.preventDefault();
            setError('');

            if (verificationCode !== generatedCode) {
              setError('Code de vérification incorrect.');
              return;
            }

            setStep('form');
          };

          const handleFormSubmit = async (e) => {
            e.preventDefault();
            setError('');
            setLoading(true);

            if (!formData.position) {
              setError('Veuillez sélectionner votre position.');
              setLoading(false);
              return;
            }

            // Préparer les données du vote
            const voteData = {
              email: email,
              position: formData.position,
              commentaire: formData.commentaire,
              timestamp: new Date().toISOString(),
              date: new Date().toLocaleString('fr-FR')
            };

            // Sauvegarder dans Google Sheets
            const saved = await saveVoteToGoogleSheets(voteData);
            
            if (saved) {
              localStorage.setItem('formSubmitted', 'true');
              localStorage.setItem('submittedEmail', email);
              setStep('submitted');
            } else {
              setError('Erreur lors de la sauvegarde du vote. Réessayez.');
            }

            setLoading(false);
          };

          const handleInputChange = (e) => {
            setFormData({
              ...formData,
              [e.target.name]: e.target.value
            });
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4">
              <div className="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
                <div className="text-center mb-6">
                  <h1 className="text-2xl font-bold text-gray-800 mb-2">
                    Vote : Blocage de Vendredi
                  </h1>
                  <p className="text-sm text-gray-600">
                    Université de Montpellier - Étudiants uniquement
                  </p>
                </div>

                {error && (
                  <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
                    <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                    <p className="text-sm text-red-800">{error}</p>
                  </div>
                )}

                {step === 'email' && (
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Adresse email universitaire *
                      </label>
                      <div className="relative">
                        <Mail className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                        <input
                          type="email"
                          value={email}
                          onChange={(e) => setEmail(e.target.value)}
                          placeholder="prenom.nom@etu.umontpellier.fr"
                          className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          required
                          disabled={loading}
                        />
                      </div>
                      <p className="mt-1 text-xs text-gray-500">
                        Seules les adresses @etu.umontpellier.fr sont acceptées
                      </p>
                    </div>
                    <button
                      onClick={handleEmailSubmit}
                      disabled={loading || !canResend}
                      className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      {loading ? (
                        <>
                          <Loader className="w-5 h-5 animate-spin" />
                          Envoi en cours...
                        </>
                      ) : !canResend ? (
                        `Attendre ${countdown}s`
                      ) : (
                        'Recevoir le code'
                      )}
                    </button>
                    {!canResend && countdown > 0 && (
                      <p className="text-xs text-center text-gray-500 mt-2">
                        Protection anti-spam : attendez {countdown} secondes avant de renvoyer
                      </p>
                    )}
                  </div>
                )}

                {step === 'verify' && (
                  <div className="space-y-4">
                    <div className="bg-blue-50 p-4 rounded-lg mb-4">
                      <p className="text-sm text-blue-800">
                        Un code de vérification a été envoyé à <strong>{email}</strong>
                      </p>
                      <p className="text-xs text-blue-600 mt-2">
                        Vérifiez vos spams si vous ne le trouvez pas.
                      </p>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Code de vérification *
                      </label>
                      <input
                        type="text"
                        value={verificationCode}
                        onChange={(e) => setVerificationCode(e.target.value)}
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') handleVerification(e);
                        }}
                        placeholder="123456"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-2xl tracking-widest"
                        maxLength={6}
                        required
                      />
                    </div>
                    <button
                      onClick={handleVerification}
                      className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      Vérifier
                    </button>
                    <button
                      onClick={() => setStep('email')}
                      className="w-full text-gray-600 py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors text-sm"
                    >
                      Modifier l'email
                    </button>
                  </div>
                )}

                {step === 'form' && (
                  <div className="space-y-4">
                    <div className="bg-green-50 p-3 rounded-lg mb-4 flex items-center gap-2">
                      <CheckCircle className="w-5 h-5 text-green-600" />
                      <p className="text-sm text-green-800">Email vérifié: {email}</p>
                    </div>

                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                      <h3 className="font-semibold text-blue-900 mb-2">
                        Question :
                      </h3>
                      <p className="text-blue-800">
                        Êtes-vous pour ou contre le blocage de l'université vendredi prochain ?
                      </p>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-3">
                        Votre position *
                      </label>
                      <div className="space-y-2">
                        <label className="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                          <input
                            type="radio"
                            name="position"
                            value="pour"
                            checked={formData.position === 'pour'}
                            onChange={handleInputChange}
                            className="w-4 h-4 text-green-600 focus:ring-green-500"
                          />
                          <span className="ml-3 text-gray-700 font-medium">✅ Pour le blocage</span>
                        </label>
                        
                        <label className="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                          <input
                            type="radio"
                            name="position"
                            value="contre"
                            checked={formData.position === 'contre'}
                            onChange={handleInputChange}
                            className="w-4 h-4 text-red-600 focus:ring-red-500"
                          />
                          <span className="ml-3 text-gray-700 font-medium">❌ Contre le blocage</span>
                        </label>
                        
                        <label className="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                          <input
                            type="radio"
                            name="position"
                            value="neutre"
                            checked={formData.position === 'neutre'}
                            onChange={handleInputChange}
                            className="w-4 h-4 text-gray-600 focus:ring-gray-500"
                          />
                          <span className="ml-3 text-gray-700 font-medium">⚪ Pas d'avis / Ne se prononce pas</span>
                        </label>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Commentaire (optionnel)
                      </label>
                      <textarea
                        name="commentaire"
                        value={formData.commentaire}
                        onChange={handleInputChange}
                        rows={4}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="Exprimez votre opinion, vos raisons..."
                        disabled={loading}
                      />
                    </div>

                    <button
                      onClick={handleFormSubmit}
                      disabled={loading}
                      className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      {loading ? (
                        <>
                          <Loader className="w-5 h-5 animate-spin" />
                          Envoi en cours...
                        </>
                      ) : (
                        'Soumettre mon vote'
                      )}
                    </button>
                  </div>
                )}

                {step === 'submitted' && (
                  <div className="text-center py-8">
                    <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <CheckCircle className="w-10 h-10 text-green-600" />
                    </div>
                    <h2 className="text-xl font-bold text-gray-800 mb-2">
                      Vote enregistré !
                    </h2>
                    <p className="text-gray-600 mb-4">
                      Merci d'avoir participé au vote.
                    </p>
                    <div className="bg-gray-50 p-4 rounded-lg text-left">
                      <p className="text-sm text-gray-600 mb-1">Email: {email}</p>
                      <p className="text-sm font-semibold text-gray-800">
                        Position: {
                          formData.position === 'pour' ? '✅ Pour le blocage' :
                          formData.position === 'contre' ? '❌ Contre le blocage' :
                          '⚪ Pas d\'avis'
                        }
                      </p>
                    </div>
                  </div>
                )}

                {step === 'blocked' && (
                  <div className="text-center py-8">
                    <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <AlertCircle className="w-10 h-10 text-orange-600" />
                    </div>
                    <h2 className="text-xl font-bold text-gray-800 mb-2">
                      Vote déjà enregistré
                    </h2>
                    <p className="text-gray-600 mb-4">
                      Vous avez déjà voté avec l'adresse {email}.
                    </p>
                    <p className="text-sm text-gray-500">
                      Un seul vote par personne est autorisé.
                    </p>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<UMontpellierForm />, document.getElementById('root'));
    </script>
</body>
</html>
